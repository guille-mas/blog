---
slug: "build-a-php-dev-environment-your-team-will-love/index.html"
title: "Build a PHP 7 development environment your team will love"
intro: "Learn to build a portable PHP development environment with Docker"
tools: "docker gnu-make php xdebug"
date: "02-10-2020"
publish: true
blog: true
category: tutorial
---
import { CodeWave } from "gatsby-theme-waves"
import Code from "components/code"
import "prismjs/components/prism-docker"

When we build products, we must think on those who consume them, and I believe the same should happen with the code and infrastructure we build.  
The time our team will need in order to be proficient with the tools we build, will greatly depend on how we built them.  
Better than throwing a bunch of lengthy notes with the steps required to get our project running to another developer. It pays off in the long run, for you and your organization, to keep in mind everyone who will end up using it, which are not only the final consumers.  

<br/>

In this post I will help you demistify Docker, by using it to wrap your PHP projects into a portable development environment that can be reused by your development team to quickly get a fully working development environment. By your operations team to understand the requirements of your project. And even by your QA and production teams to run early demos or tests.

<br />

The development environment will include:

- PHP 7.4.2
- A working Apache web server listening at port 80
- An Xdebug PHP debugging server, listening on port 9000
- A high level easy to use client interface
- High level docummentation to quickly get started

<br />

I will assume you grasp the basics about using bash, Linux, PHP configuration, and howto use a Makefile

### Requirements

Before creating our first container, we will need **Docker engine** and **GNU Make**.  

<br/>

The easiest way to setup Docker in Windows and MacOS is by getting [Docker Desktop](https://www.docker.com/products/docker-desktop).  
If you are using Linux you can use your package manager of choice, or compile it from source.

<br/>

GNU Make might be already available in Windows through PowerShell, and its usually present on most popular Linux distros as well as MacOS.

### A few basic Docker concepts

- Docker it's a tool that allows you to pack your applications around a runtime environment of your choice.
- Any computer capable of running a Docker engine will run your app inside the same runtime environment. Regardless of the operating system running your host (The computer running Docker).

##### Images and containers

A Docker image it's the blueprint from where Docker containers are created.  
Images can be pushed to Docker repositories, where they can be consumed by others to create images or containers.  
An image it's a build time construct, and a container it's a runtime construct.  
For those familiar with OOP; A Docker image could be seen as a "class" and a container as an "instance".  

<br/>

Containers alliviate a lot of heavy lifting from error prone tasks, by packaging your apps with everything they need to work with; A minimum operating system, libraries, modules, configuration files, environment variables, and firewall rules.  

### Hello Container

This blog can serve as an example of their power. You can run the same version that's available at https://guille.cloud, locally, without caring or knowing what's under the hoods. And do so any time you want, expecting the same results.

<br/>

Go ahead and try it

<Code 
language="bash" 
snippet={`docker run -p 8000:8000 --rm guillermomaschwitz/blog:1-production`} 
output={`
Unable to find image 'guillermomaschwitz/blog:1-production' locally
1-production: Pulling from guillermomaschwitz/blog
89d9c30c1d48: Already exists 
14a328a7d891: Already exists 
7c9d8f6918aa: Already exists 
0f41cc513c96: Already exists 
60eb08073fc4: Pull complete 
925927e5d4b3: Pull complete 
6a566d986f65: Pull complete 
Digest: sha256:97219d2c6fed07921b8f3ca551e91480471599fe4720ef11bb4cb17d1793aaec
Status: Downloaded newer image for guillermomaschwitz/blog:1-production
info gatsby serve running at: http://0.0.0.0:8000/
`}/>  

An exact version of this website will be available at http://0.0.0.0:8000 or http://localhost:8000. In fact, you could keep reading this article from it, cause that container has the same content you are seeing here.

<br/>

Let's check the running container on another terminal

<Code 
language="bash" 
snippet={`docker container ls`} 
output={`
CONTAINER ID        IMAGE                                  COMMAND                  CREATED             STATUS              PORTS                    NAMES
7ecd413bdf91        guillermomaschwitz/blog:1-production   "docker-entrypoint.sâ€¦"   23 minutes ago      Up 23 minutes       0.0.0.0:8000->8000/tcp   peaceful_almeida
`}/>  

Stop the container

<Code 
language="bash"
snippet={`docker stop peaceful_almeida`}
output={`peaceful_almeida`} />

Hey, in case you didn't noticed, that was a nodejs environment, with a gatsby based website, and a long list of requirements that you don't need to be aware of. It just works.

<br/>

Behind the courtains Docker did all the heavy lifting for you:

1. First, it attempted to find a local image **guillermomaschwitz/blog:1-production** and ended up pulling it from its remote repo.
2. Started a new container with the random name **peaceful_almeida**
3. Container's port 8000 gets binded to localhost's (0.0.0.0) port 8000
3. A web server's process it's started inside the container, streaming logs to the screen.
4. The container gets destroyed once you kill the app cause we used the flag --rm.

### The purpose of custom Docker images

Real life projects have specific requirements we need to setup in order to start them; Vendor libraries, system modules, configuration files, source files, etc.
Docker allows us to extend existing images containing some of those requirements, and create a new environment blueprint on top of them.  


### Using Docker to build a PHP 7 development environment

First, create a folder for your project and share your project's folder with Docker.  
At least in Docker Desktop for MacOS, it goes like this:  

1. Go to Docker Desktop's preferences
2. Go to File Sharing, under Resources section
3. Add your folder and apply changes

Second, create a new file in the root of your project and name it `Dockerfile`.  
That's the default file name Docker expects for your custom image.  

#### The Dockerfile

Docker images build code is usually written on a file with name Dockerfile. So let's create it at the root of our project.  
A complete reference to Dockerfile syntax can be found at [the official docs](https://docs.docker.com/engine/reference/builder/) if you want to check.  
Next, you will see some of these instructions, while we write the code to build our image.

<CodeWave>

```docker
# My PHP Development environment
FROM php:7.4.2-apache
```

##### Parent image

The first instruction every Dockerfile needs to have is **FROM**.  
It tells Docker, which image to use as a base for your custom image, and how to name your custom image.  
The image you choose must exist and you need to have access to it.  

<br/>

Docker has a vibrant ecosystem of images you can consume. One of the most popular repositories for storing them is [DockerHub](https://hub.docker.com/), where you can pull public images from thousands of repositories built by devops practitioners.  

> For improved security and stability, your custom images should rely on [official images](https://docs.docker.com/docker-hub/official_images/), which are maintained by stricter quality standards.

<br/>

For this tutorial we are going to use an [official PHP image, bundled with Apache](https://hub.docker.com/_/php). If you ever want to check it's source code, you can find it here: [Dockerfile available here](https://github.com/docker-library/php/blob/master/7.4/buster/apache/Dockerfile).  

```docker
# My PHP Development environment
FROM php:7.4.2-apache AS dev-image
```

Finally, we are referencing our custom image, in the context of our build process, as `dev-image`  

```docker
# My PHP Development environment
FROM php:7.4.2-apache AS dev-image
RUN pecl install xdebug-2.8.1 \
    && docker-php-ext-enable xdebug
```

##### Install Xdebug

XDebug it's a common PHP development extension that packs handy features to make your life easier while debugging stuff.  
One of those things it's a PHP debugging server that's usually listening to port 9000 once enabled.  

<br/>

You can configure VSCode or other editor/IDE to connect to that port.  

<br/>

Every time you send an HTTP request to your website with the parameter XDEBUG_SESSION_START=session_name, Xdebug will start a debugging session from port 9000, that you can control from any [DBGP](https://xdebug.org/docs/dbgp) compliant client.

<br/>

As docummented on the docker image's website, we should use _pecl_ to install the extension, and _docker-php-ext-enable_ to enable it.  

<br/>


```docker
# My PHP Development environment
FROM php:7.4.2-apache AS dev-image
RUN pecl install xdebug-2.8.1 \
    && docker-php-ext-enable xdebug
# @todo Copy xdebug config into the container 
EXPOSE 9000
```

##### Expose XDebug debugging server port

Expose port 9000 and copy the xdebug configuration settings required to enable the PHP remote debugging server at port 9000.

</CodeWave>

And that's it!

<br/>

Now that you have a Dockerfile, let's build the image.


#### Building your image

Get back to your shell and run:

<Code 
    language="bash" 
    snippet={`docker build -t my-project:1.0-development --target dev-image .`} 
    output={`
Sending build context to Docker daemon  3.072kB
Step 1/2 : FROM php:7.4.2-apache AS dev-image
...
Step 2/2 : RUN pecl install xdebug-2.8.1     && docker-php-ext-enable xdebug
...
 ---> 105de83fa100
Successfully built 105de83fa100
Successfully tagged my-project:1.0-development
`} />

Docker will build a new docker image based on **dev-image** and tag it as **my-project:1.0-development**.

<br/>

If everything went well, you should see **my-project** custom image between your list of locally available Docker images, and the base image, used to build it.

<Code 
    language="bash" 
    snippet={`docker image ls`}
    output={`
REPOSITORY                TAG                 IMAGE ID            CREATED             SIZE
my-project                1.0-development     105de83fa100        31 minutes ago      416MB
php                       7.4.2-apache        4165e46dd82e        2 weeks ago         414MB
`} />

### Whats next

In a next post, I plan to show you howto use docker-compose to effectively documment in code our development environment.
We will explore the advantages of following a declarative approach instead of an imperative one, and we will see how docker-compose can help us do so.

<br/>

Later I would like to show you to write one image per environment type using Docker multi stage builds.

<br/>

This post is a work in progress. Let me know your thoughts; If you found this useful or not, and any errors you might spot or questions you might have.  

<br/>

Thanks a lot for your time!

